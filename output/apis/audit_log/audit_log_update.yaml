version: "1.0"
method: PUT
path: "/audit_logs/:id/update"
description: "Actualizar audit_log"

auth:
  required: true
  permissions: ["audit_logs.write"]

params:
  path:
    - name: id
      type: int
      required: true
      validation:
        min: 1
      error_message: "Debe proporcionar un ID v√°lido"
  
  body:
    - name: "user_id"
      type: "int"
      required: false
      validation:
        max: 2147483647
        min: -2147483648
    - name: "action"
      type: "string"
      required: false
      validation:
        max_length: 50
    - name: "table_name"
      type: "string"
      required: false
      validation:
        max_length: 100
    - name: "record_id"
      type: "int"
      required: false
      validation:
        max: 2147483647
        min: -2147483648
    - name: "old_values"
      type: "object"
      required: false
    - name: "new_values"
      type: "object"
      required: false
    - name: "ip_address"
      type: "string"
      required: false
    - name: "user_agent"
      type: "string"
      required: false

commands:
  # Verificar que existe
  - type: validation
    sql: "SELECT COUNT(*) as count FROM audit_log WHERE id = :id"
    condition: "count = 0"
    on_true:
      action: stop
      http_code: 404
      message: "audit_log no encontrado"
  
  # Actualizar
  - type: exec
    sql: |
      UPDATE audit_log SET
          
          user_id = COALESCE(:user_id, user_id)
          ,
          action = COALESCE(:action, action)
          ,
          table_name = COALESCE(:table_name, table_name)
          ,
          record_id = COALESCE(:record_id, record_id)
          ,
          old_values = COALESCE(:old_values, old_values)
          ,
          new_values = COALESCE(:new_values, new_values)
          ,
          ip_address = COALESCE(:ip_address, ip_address)
          ,
          user_agent = COALESCE(:user_agent, user_agent)
        ,updated_at = NOW()
      WHERE id = :id
      RETURNING *

response:
  success:
    code: 200
    message: "audit_log actualizado exitosamente"

hooks:
  after:
    - type: cache_invalidate
      keys: ["audit_logs:list:*", "audit_logs:{id}"]